name: Zero Downtime Deployment of Next App to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Calendar App to Server
    runs-on: ubuntu-latest
    env:
      SERVICE_NAME: calendar-frontend
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      PROXY_NETWORK: ${{ secrets.PROXY_NETWORK }}
      GIT_BRANCH: ${{ github.ref_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connectivity check (DNS + SSH port)
        run: |
          set -e
          HOST="${{ secrets.DEPLOY_HOST }}"
          PORT="${{ secrets.DEPLOY_PORT }}"
          PORT="${PORT:-22}"

          echo "Host: $HOST"
          echo "Port: $PORT"

          echo "ICMP ping (may fail if firewall blocks ICMP)..."
          ping -c 3 "$HOST" || echo "Ping failed (ICMP likely blocked); continuing to TCP check."

          echo "DNS resolution:"
          getent ahosts "$HOST"

          echo "TCP reachability on port $PORT:"
          nc -z -v -w 5 "$HOST" "$PORT"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            set -euo pipefail

            DEPLOY_PATH="${DEPLOY_PATH:-/opt/passport/calendar-frontend}"
            SERVICE_NAME="${SERVICE_NAME:-calendar-frontend}"
            PROXY_NETWORK="${PROXY_NETWORK:-web}"
            GIT_BRANCH="${GIT_BRANCH:-main}"

            echo "Deploying branch: ${GIT_BRANCH}"
            echo "Target path: ${DEPLOY_PATH}"
            echo "Service name: ${SERVICE_NAME}"
            echo "Proxy network: ${PROXY_NETWORK}"

            cd "${DEPLOY_PATH}"

            # Ensure environment file exists
            if [ ! -f ".env" ]; then
              echo "Missing .env in ${DEPLOY_PATH}. Aborting."
              exit 1
            fi

            # Ensure proxy network exists (used by existing reverse proxy)
            docker network inspect "${PROXY_NETWORK}" >/dev/null 2>&1 || docker network create "${PROXY_NETWORK}"

            echo "üì• Pulling latest code..."
            git fetch --all
            git reset --hard "origin/${GIT_BRANCH}"

            echo "üî® Building new image..."
            docker compose build --no-cache "${SERVICE_NAME}"

            echo "‚ö° Starting new app instance alongside old one..."
            docker compose up -d --scale "${SERVICE_NAME}"=2 --no-recreate

            echo "‚è≥ Waiting for new container to become healthy..."
            sleep 15
            if ! docker ps --filter "name=${SERVICE_NAME}" --filter "health=healthy" | grep -q "${SERVICE_NAME}"; then
              echo "‚ö†Ô∏è  New container not healthy yet, waiting 15s more..."
              sleep 15
            fi

            echo "‚ôªÔ∏è  Removing old container, keeping new one..."
            docker compose up -d --scale "${SERVICE_NAME}"=1 --remove-orphans

            echo "üßπ Cleaning up unused images..."
            docker image prune -f

            echo "‚úÖ Deployment complete!"
            docker compose ps
            docker system df

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi
